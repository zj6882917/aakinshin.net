<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="description" content="Andrey Akinshin">
    <meta name="author" content="Andrey Akinshin">
    <link href="/img/favicon.ico" rel="icon" type="image/x-icon"/>
    <meta name="keywords" content=''>

    <title>Andrey Akinshin</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">

    <!-- Custom styles -->
    <link href="/css/about.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/blog.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/highlight.css" rel="stylesheet" type="text/css" media="all">

    <!-- Feeds -->
    <link href="/en/rss.xml" type="application/rss+xml" rel="alternate" title="Blog RSS Feed" />
    <link href="/en/atom.xml" type="application/atom+xml" rel="alternate" title="Blog ATOM Feed" />

    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-41419012-5', 'auto');
      ga('send', 'pageview');
    </script>
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter28700916 = new Ya.Metrika({id:28700916,
                        clickmap:true,
                        trackLinks:true,
                        accurateTrackBounce:true});
            } catch(e) { }
        });
        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";
        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
    </script>
    <!-- /Yandex.Metrika counter -->
    <!-- Disqus -->
    <script id="dsq-count-scr" src="//aakinshinnet-en.disqus.com/count.js" async></script>
  </head>

  <body>
     <div class="blog-masthead">
      <div class="container">
        <nav class="nav blog-nav">
          <a class="nav-link" id="nav-link-blog" href="/blog/">Blog</a>
          <a class="nav-link" id="nav-link-blog-content" href="/blog/content/">Content</a>
          <a class="nav-link" id="nav-link-about" href="/about/">About author</a>
          <a class="nav-link" href='/ru/blog/tag/dotnet/'>Russian version</a>
        </nav>
      </div>
    </div>

    <div class="container">
      <div class="blog-main">

<h1 id="dotnet">Posts about .NET</h1>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/bdn-v0_10_7/'>BenchmarkDotNet v0.10.7</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> June 05, 2017.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
                <a href="/blog/tag/benchmarkdotnet"><span class="badge badge-pill badge-info">BenchmarkDotNet</span></a>
                <a href="/blog/tag/benchmarking"><span class="badge badge-pill badge-info">benchmarking</span></a>
        </span><br /><br />
        <p>BenchmarkDotNet v0.10.7 has been released.
In this post, I will briefly cover the following features:</p>
<ul>
<li>LINQPad support</li>
<li>Filters and categories</li>
<li>Updated Setup/Cleanup attributes</li>
<li>Better Value Types support</li>
<li>Building Sources on Linux</li>
</ul>
</p>
        <a href='/blog/post/bdn-v0_10_7/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/bdn-v0_10_7/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/namedmutex-on-mono/'>A bug story about named mutex on Mono</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> February 13, 2017.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/rider"><span class="badge badge-pill badge-info">Rider</span></a>
                <a href="/blog/tag/bugs"><span class="badge badge-pill badge-info">Bugs</span></a>
                <a href="/blog/tag/xplat"><span class="badge badge-pill badge-info">Xplat</span></a>
                <a href="/blog/tag/mono"><span class="badge badge-pill badge-info">Mono</span></a>
                <a href="/blog/tag/coreclr"><span class="badge badge-pill badge-info">CoreCLR</span></a>
        </span><br /><br />
        <p>When you write some multithreading magic on .NET,
you can use a cool synchronization primitive called <a href="https://msdn.microsoft.com/en-us/library/system.threading.mutex(v=vs.110).aspx">Mutex</a>:</p>
<pre><code class="language-cs">var mutex = new Mutex(false, &quot;Global\\MyNamedMutex&quot;);
</code></pre>
<p>You also can make it <a href="https://msdn.microsoft.com/en-us/library/f55ddskf(v=vs.110).aspx">named</a> (and share the mutex between processes)
which works perfectly on Windows:</p>
<div class="mx-auto">
  <img class="mx-auto d-block" width="600" src="/img/posts/dotnet/namedmutex-on-mono/front.png" />
</div>
<p>However, today the .NET Framework is cross-platform, so this code should work on any operation system.
What will happen if you use named mutex on Linux or MacOS with the help of Mono or CoreCLR?
Is it possible to create some tricky bug based on this case?
Of course, it does.
Today I want to tell you a story about such bug in <a href="https://www.jetbrains.com/rider/">Rider</a> which was a headache for several weeks.</p>
</p>
        <a href='/blog/post/namedmutex-on-mono/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/namedmutex-on-mono/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/invaliddataexception-in-getprocesses/'>InvalidDataException in Process.GetProcesses</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> February 10, 2017.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/rider"><span class="badge badge-pill badge-info">Rider</span></a>
                <a href="/blog/tag/bugs"><span class="badge badge-pill badge-info">Bugs</span></a>
                <a href="/blog/tag/xplat"><span class="badge badge-pill badge-info">Xplat</span></a>
                <a href="/blog/tag/coreclr"><span class="badge badge-pill badge-info">CoreCLR</span></a>
        </span><br /><br />
        <p>Consider the following program:</p>
<pre><code class="language-cs">public static void Main(string[] args)
{
    try
    {
        Process.GetProcesses();
    }
    catch (Exception e)
    {
        Console.WriteLine(e);
    }
}
</code></pre>
<p>It seems that all exceptions should be caught.
However, <em>sometimes</em>, I had the following exception on Linux with <code>dotnet cli-1.0.0-preview2</code>:</p>
<pre><code>$ dotnet run
System.IO.InvalidDataException: Found invalid data while decoding.
   at System.IO.StringParser.ParseNextChar()
   at Interop.procfs.TryParseStatFile(String statFilePath, ParsedStat&amp; result, ReusableTextReader reusableReader)
   at System.Diagnostics.ProcessManager.CreateProcessInfo(ParsedStat procFsStat, ReusableTextReader reusableReader)
   at System.Diagnostics.ProcessManager.CreateProcessInfo(Int32 pid, ReusableTextReader reusableReader)
   at System.Diagnostics.ProcessManager.GetProcessInfos(String machineName)
   at System.Diagnostics.Process.GetProcesses(String machineName)
   at System.Diagnostics.Process.GetProcesses()
   at DotNetCoreConsoleApplication.Program.Main(String[] args) in /home/akinshin/Program.cs:line 12
</code></pre>
<p>How is that possible?</p>
</p>
        <a href='/blog/post/invaliddataexception-in-getprocesses/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/invaliddataexception-in-getprocesses/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/rider-nuget-search/'>Why is NuGet search in Rider so fast?</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> February 08, 2017.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/rider"><span class="badge badge-pill badge-info">Rider</span></a>
                <a href="/blog/tag/nuget"><span class="badge badge-pill badge-info">NuGet</span></a>
        </span><br /><br />
        <p>I'm the guy who develops the NuGet manager in <a href="https://www.jetbrains.com/rider/">Rider</a>.
It's not ready yet, there are some bugs here and there, but it already works pretty well.
The feature which I am most proud of is smart and fast search:</p>
<div class="mx-auto">
  <img class="mx-auto d-block" width="400" src="/img/posts/dotnet/rider-nuget-search/front.gif" />
</div>
<p>Today I want to share with you some technical details about how it was implemented.</p>
</p>
        <a href='/blog/post/rider-nuget-search/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/rider-nuget-search/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/nuget2-and-directoryseparatorchar/'>NuGet2 and a DirectorySeparatorChar bug</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> February 06, 2017.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/rider"><span class="badge badge-pill badge-info">Rider</span></a>
                <a href="/blog/tag/bugs"><span class="badge badge-pill badge-info">Bugs</span></a>
                <a href="/blog/tag/performance"><span class="badge badge-pill badge-info">Performance</span></a>
                <a href="/blog/tag/nuget"><span class="badge badge-pill badge-info">NuGet</span></a>
        </span><br /><br />
        <p>In <a href="https://www.jetbrains.com/rider/">Rider</a>, we care a lot about performance.
I like to improve the application responsiveness and do interesting optimizations all the time.
Rider is already well-optimized, and it's often hard to make significant performance improvements, so usually I do micro-optimizations which do not have a very big impact on the whole application.
However, sometimes it's possible to improve the speed of a feature 100 times with just a few lines of code.</p>
<p>Rider is based on <a href="https://www.jetbrains.com/resharper/">ReSharper</a>, so we have a lot of cool features out of the box.
One of these features is <a href="https://www.jetbrains.com/help/resharper/2016.3/Code_Analysis__Solution-Wide_Analysis.html">Solution-Wide Analysis</a>
which lets you constantly keep track of issues in your solution.
Sometimes, solution-wide analysis takes a lot of time to run because there are many files which should be analyzed.
Of course, it works super fast on small and projects.</p>
<p>Let's talk about a performance bug (<a href="https://youtrack.jetbrains.com/issue/RIDER-3742">#RIDER-3742</a>) that we recently had.</p>
<ul>
<li><em>Repro:</em> Open Rider, create a new &quot;ASP .NET MVC Application&quot;, enable solution wide-analysis.</li>
<li><em>Expected:</em> The analysis should take 1 second.</li>
<li><em>Actual:</em> The analysis takes 1 second on Windows and <strong>2 minutes</strong> on Linux and MacOS.</li>
</ul>
</p>
        <a href='/blog/post/nuget2-and-directoryseparatorchar/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/nuget2-and-directoryseparatorchar/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/perfex-div/'>Performance exercise: Division</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> December 26, 2016.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/performanceexercise"><span class="badge badge-pill badge-info">PerformanceExercise</span></a>
                <a href="/blog/tag/benchmarking"><span class="badge badge-pill badge-info">Benchmarking</span></a>
                <a href="/blog/tag/math"><span class="badge badge-pill badge-info">Math</span></a>
        </span><br /><br />
        <p>In the previous post, we <a href="/en/blog/dotnet/perfex-min/">discussed</a> the performance space of the minimum function
which was implemented via a simple ternary operator and with the help of bit magic.
Now we continue to talk about performance and bit hacks.
In particular, we will divide a positive number by three:</p>
<pre><code class="language-cs">uint Div3Simple(uint n)   =&gt; n / 3;
uint Div3BitHacks(uint n) =&gt; (uint)((n * (ulong)0xAAAAAAAB) &gt;&gt; 33);
</code></pre>
<p>As usual, it's hard to say which method is faster in advanced because the performance depends on the environment.
Here are some interesting results:</p>
<table class="table table-sm">
  <tr> <th></th>              <th>Simple</th>              <th>BitHacks</th>             </tr>
  <tr> <th>LegacyJIT-x86</th> <td class="norm">≈8.3ns</td> <td class="fast">≈2.6ns</td>  </tr>
  <tr> <th>LegacyJIT-x64</th> <td class="fast">≈2.6ns</td> <td class="fast">≈1.7ns</td>  </tr>
  <tr> <th>RyuJIT-x64   </th> <td class="norm">≈6.9ns</td> <td class="fast">≈1.5ns</td>  </tr>
  <tr> <th>Mono4.6.2-x86</th> <td class="norm">≈8.5ns</td> <td class="slow">≈14.4ns</td> </tr>
  <tr> <th>Mono4.6.2-x64</th> <td class="norm">≈8.3ns</td> <td class="fast">≈2.8ns</td>  </tr>
</table>
</p>
        <a href='/blog/post/perfex-div/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/perfex-div/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/perfex-min/'>Performance exercise: Minimum</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> December 20, 2016.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/performanceexercise"><span class="badge badge-pill badge-info">PerformanceExercise</span></a>
                <a href="/blog/tag/benchmarking"><span class="badge badge-pill badge-info">Benchmarking</span></a>
                <a href="/blog/tag/math"><span class="badge badge-pill badge-info">Math</span></a>
        </span><br /><br />
        <p>Performance is tricky. Especially, if you are working with very fast operations. In today benchmarking exercise, we will try to measure performance of two simple methods which calculate minimum of two numbers. Sounds easy? Ok, let's do it, here are our guinea pigs for today:</p>
<pre><code class="language-cs">int MinTernary(int x, int y)  =&gt; x &lt; y ? x : y;
int MinBitHacks(int x, int y) =&gt; x &amp; ((x - y) &gt;&gt; 31) | y &amp; (~(x - y) &gt;&gt; 31);
</code></pre>
<p>And here are some results:</p>
<table class="table table-sm">
  <style type="text/css" scoped>
    td.slow { color: #ff4444; } 
    td.fast { color: #00C851; }
  </style>
  
  <tr> <th></th> <th colspan="2">Random</th>        <th colspan="2">Const</th>          </tr>
  <tr> <th></th> <th>Ternary</th> <th>BitHacks</th> <th>Ternary</th> <th>BitHacks</th>  </tr>
  <tr> <th>LegacyJIT-x86</th>
       <td class="slow">≈643µs</td>
       <td class="fast">≈227µs</td>
       <td class="fast">≈160µs</td>
       <td class="slow">≈226µs</td>
  </tr>
  <tr> <th>LegacyJIT-x64</th>
       <td class="slow">≈450µs</td>
       <td class="fast">≈123µs</td>
       <td class="fast">≈68µs</td>
       <td class="slow">≈123µs</td>
  </tr>
  <tr> <th>RyuJIT-x64</th>
       <td class="slow">≈594µs</td>
       <td class="fast">≈241µs</td>
       <td class="fast">≈180µs</td>
       <td class="slow">≈241µs</td>
  </tr>
  <tr> <th>Mono-x64</th>
       <td class="fast">≈203µs</td>
       <td class="slow">≈283µs</td>
       <td class="fast">≈204µs</td>
       <td class="slow">≈282µs</td>
  </tr>
</table>
<p>What's going on here? Let's discuss it in detail.</p>
</p>
        <a href='/blog/post/perfex-min/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/perfex-min/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/stopwatch/'>Stopwatch under the hood</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> September 09, 2016.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/hardware"><span class="badge badge-pill badge-info">Hardware</span></a>
                <a href="/blog/tag/timers"><span class="badge badge-pill badge-info">Timers</span></a>
                <a href="/blog/tag/internals"><span class="badge badge-pill badge-info">Internals</span></a>
        </span><br /><br />
        <p>In <a href="/en/blog/dotnet/datetime/">the previous post</a>, we discussed <code>DateTime</code>.
This structure can be used in situations when you don't need a good level of precision.
If you want to do high-precision time measurements, you need a better tool because <code>DateTime</code> has a small resolution and a big latency.
Also, time is tricky, you can create wonderful bugs if you don't understand how it works (see <a href="http://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time">Falsehoods programmers believe about time</a> and <a href="http://infiniteundo.com/post/25509354022/more-falsehoods-programmers-believe-about-time">More falsehoods programmers believe about time</a>).</p>
<p>In this post, we will briefly talk about the <a href="https://msdn.microsoft.com/library/system.diagnostics.stopwatch.aspx">Stopwatch</a> class:</p>
<ul>
<li>Which kind of hardware timers could be a base for <code>Stopwatch</code></li>
<li>High precision timestamp API on Windows and Linux</li>
<li>Latency and Resolution of <code>Stopwatch</code> in different environments</li>
<li>Common pitfalls: which kind of problems could we get trying to measure small time intervals</li>
</ul>
<p>If you are not a .NET developer, you can also find a lot of useful information in this post: mainly we will discuss low-level details of high-resolution timestamping (probably your favorite language also uses the same API).
As usual, you can also find useful links for further reading.</p>
</p>
        <a href='/blog/post/stopwatch/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/stopwatch/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/datetime/'>DateTime under the hood</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> August 19, 2016.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/timers"><span class="badge badge-pill badge-info">Timers</span></a>
                <a href="/blog/tag/internals"><span class="badge badge-pill badge-info">Internals</span></a>
        </span><br /><br />
        <p><a href="https://msdn.microsoft.com/library/system.datetime.aspx">DateTime</a> is a widely used .NET type. A lot of developers use it all the time, but not all of them really know how it works. In this post, I discuss <a href="https://msdn.microsoft.com/library/system.datetime.utcnow.aspx">DateTime.UtcNow</a>: how it's implemented, what the latency and the resolution of <code>DateTime</code> on Windows and Linux, how the resolution can be changed, and how it can affect your application. This post is an overview, so you probably will not see super detailed explanations of some topics, but you will find a lot of useful links for further reading.</p>
</p>
        <a href='/blog/post/datetime/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/datetime/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/legacyjitx86-and-first-method-call/'>LegacyJIT-x86 and first method call</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> April 04, 2016.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
                <a href="/blog/tag/jit"><span class="badge badge-pill badge-info">JIT</span></a>
                <a href="/blog/tag/benchmarks"><span class="badge badge-pill badge-info">Benchmarks</span></a>
        </span><br /><br />
        <p>Today I tell you about one of my favorite benchmarks (this method doesn't return a useful value, we need it only as an example):</p>
<pre><code class="language-cs">[Benchmark]
public string Sum()
{
    double a = 1, b = 1;
    var sw = new Stopwatch();
    for (int i = 0; i &lt; 10001; i++)
        a = a + b;
    return string.Format(&quot;{0}{1}&quot;, a, sw.ElapsedMilliseconds);
}
</code></pre>
<p>An interesting fact: if you call <code>Stopwatch.GetTimestamp()</code> before the first call of the <code>Sum</code> method, you improve <code>Sum</code> performance several times (works only with LegacyJIT-x86).</p>
</p>
        <a href='/blog/post/legacyjitx86-and-first-method-call/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/legacyjitx86-and-first-method-call/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/projecttypeguids/'>Visual Studio and ProjectTypeGuids.cs</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> February 27, 2016.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
                <a href="/blog/tag/visualstudio"><span class="badge badge-pill badge-info">VisualStudio</span></a>
                <a href="/blog/tag/hate"><span class="badge badge-pill badge-info">Hate</span></a>
                <a href="/blog/tag/rider"><span class="badge badge-pill badge-info">Rider</span></a>
        </span><br /><br />
        <p>It's a story about how I tried to open a project in Visual Studio for a few hours. The other day, I was going to do some work. I pulled last commits from a repo, opened Visual Studio, and prepared to start coding. However, one of a project in my solution failed to open with a strange message:</p>
<pre><code>error  : The operation could not be completed.
</code></pre>
<p>In the Solution Explorer, I had <em>&quot;load failed&quot;</em> as a project status and the following message instead of the file tree: <em>&quot;The project requires user input. Reload the project for more information.&quot;</em> Hmm, ok, I reloaded the project and got a few more errors:</p>
<pre><code>error  : The operation could not be completed.
error  : The operation could not be completed.
</code></pre>
</p>
        <a href='/blog/post/projecttypeguids/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/projecttypeguids/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/blittable/'>Blittable types</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> November 26, 2015.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
                <a href="/blog/tag/internals"><span class="badge badge-pill badge-info">Internals</span></a>
        </span><br /><br />
        <p>Challenge of the day: what will the following code display?</p>
<pre><code class="language-cs">[StructLayout(LayoutKind.Explicit)]
public struct UInt128
{
    [FieldOffset(0)]
    public ulong Value1;
    [FieldOffset(8)]
    public ulong Value2;
}
[StructLayout(LayoutKind.Sequential)]
public struct MyStruct
{
    public UInt128 UInt128;
    public char Char;
}
class Program
{
    public static unsafe void Main()
    {
        var myStruct = new MyStruct();
        var baseAddress = (int)&amp;myStruct;
        var uInt128Adress = (int)&amp;myStruct.UInt128;
        Console.WriteLine(uInt128Adress - baseAddress);
        Console.WriteLine(Marshal.OffsetOf(typeof(MyStruct), &quot;UInt128&quot;));
    }
}
</code></pre>
<p>A hint: two zeros or two another same values are wrong answers in the general case. The following table shows the console output on different runtimes:</p>
<table>
<tr><th></th><th>MS.NET-x86</th><th>MS.NET-x64</th><th>Mono</th></tr>
<tr><td>uInt128Adress - baseAddress                  </td><td>4</td><td>8</td><td>0</td></tr>
<tr><td>Marshal.OffsetOf(typeof(MyStruct), "UInt128")</td><td>0</td><td>0</td><td>0</td></tr>
</table>
<p>If you want to know why it happens, you probably should learn some useful information about blittable types.</p>
        <a href='/blog/post/blittable/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/blittable/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/ryujit-rc-and-constant-folding/'>RyuJIT RC and constant folding</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> May 12, 2015.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
                <a href="/blog/tag/jit"><span class="badge badge-pill badge-info">JIT</span></a>
                <a href="/blog/tag/ryujit"><span class="badge badge-pill badge-info">RyuJIT</span></a>
                <a href="/blog/tag/constantfolding"><span class="badge badge-pill badge-info">ConstantFolding</span></a>
        </span><br /><br />
        <p><strong>Update:</strong> The below results are valid for the release version of RyuJIT.</p>
<p>The challenge of the day: which method is faster?</p>
<pre><code class="language-cs">public double Sqrt13()
{
    return Math.Sqrt(1) + Math.Sqrt(2) + Math.Sqrt(3) + Math.Sqrt(4) + Math.Sqrt(5) + 
           Math.Sqrt(6) + Math.Sqrt(7) + Math.Sqrt(8) + Math.Sqrt(9) + Math.Sqrt(10) + 
           Math.Sqrt(11) + Math.Sqrt(12) + Math.Sqrt(13);
}
public double Sqrt14()
{
    return Math.Sqrt(1) + Math.Sqrt(2) + Math.Sqrt(3) + Math.Sqrt(4) + Math.Sqrt(5) + 
           Math.Sqrt(6) + Math.Sqrt(7) + Math.Sqrt(8) + Math.Sqrt(9) + Math.Sqrt(10) + 
           Math.Sqrt(11) + Math.Sqrt(12) + Math.Sqrt(13) + Math.Sqrt(14);
}
</code></pre>
<p>I have measured the methods performance with help of <a href="https://github.com/AndreyAkinshin/BenchmarkDotNet">BenchmarkDotNet</a> for RyuJIT RC (a part of .NET Framework 4.6 RC) and received the following results:</p>
<pre><code>// BenchmarkDotNet=v0.7.4.0
// OS=Microsoft Windows NT 6.2.9200.0
// Processor=Intel(R) Core(TM) i7-4702MQ CPU ＠ 2.20GHz, ProcessorCount=8
// CLR=MS.NET 4.0.30319.0, Arch=64-bit  [RyuJIT]
Common:  Type=Math_DoubleSqrtAvx  Mode=Throughput  Platform=X64  Jit=RyuJit  .NET=Current  

 Method |  AvrTime |    StdDev |         op/s |
------- |--------- |---------- |------------- |
 Sqrt13 | 55.40 ns |  0.571 ns |  18050993.06 |
 Sqrt14 |  1.43 ns | 0.0224 ns | 697125029.18 |
</code></pre>
<p>How so? If I add one more <code>Math.Sqrt</code> to the expression, the method starts work 40 times faster! Let's examine the situation..</p>
        <a href='/blog/post/ryujit-rc-and-constant-folding/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/ryujit-rc-and-constant-folding/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/unrolling-of-small-loops-in-different-jit-versions/'>Unrolling of small loops in different JIT versions</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> March 02, 2015.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
                <a href="/blog/tag/jit"><span class="badge badge-pill badge-info">JIT</span></a>
                <a href="/blog/tag/bugs"><span class="badge badge-pill badge-info">Bugs</span></a>
                <a href="/blog/tag/loopunrolling"><span class="badge badge-pill badge-info">LoopUnrolling</span></a>
        </span><br /><br />
        <p>Challenge of the day: what will the following code display?</p>
<pre><code class="language-cs">struct Point
{
    public int X;
    public int Y;
}
static void Print(Point p)
{
    Console.WriteLine(p.X + &quot; &quot; + p.Y);
}
static void Main()
{
    var p = new Point();
    for (p.X = 0; p.X &lt; 2; p.X++)
        Print(p);
}
</code></pre>
<p>The right answer: it depends. There is a bug in CLR2 JIT-x86 which spoil this wonderful program. This story is about optimization that called unrolling of small loops. This is a very interesting theme, let's discuss it in detail.</p>
</p>
        <a href='/blog/post/unrolling-of-small-loops-in-different-jit-versions/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/unrolling-of-small-loops-in-different-jit-versions/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/ryujit-ctp5-and-loop-unrolling/'>RyuJIT CTP5 and loop unrolling</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> March 01, 2015.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
                <a href="/blog/tag/jit"><span class="badge badge-pill badge-info">JIT</span></a>
                <a href="/blog/tag/ryujit"><span class="badge badge-pill badge-info">RyuJIT</span></a>
                <a href="/blog/tag/loopunrolling"><span class="badge badge-pill badge-info">LoopUnrolling</span></a>
        </span><br /><br />
        <p>RyuJIT will be available soon. It is a next generation JIT-compiler for .NET-applications. Microsoft likes to tell us about the benefits of SIMD using and JIT-compilation time reducing. But what about basic code optimization which is usually applying by a compiler? Today we talk about the loop unrolling (unwinding) optimization. In general, in this type of code optimization, the code</p>
<pre><code class="language-cs">for (int i = 0; i &lt; 1024; i++)
    Foo(i);
</code></pre>
<p>transforms to</p>
<pre><code class="language-cs">for (int i = 0; i &lt; 1024; i += 4)
{
    Foo(i);
    Foo(i + 1);
    Foo(i + 2);
    Foo(i + 3);
}
</code></pre>
<p>Such approach can significantly increase performance of your code. So, what's about loop unrolling in .NET?</p>
</p>
        <a href='/blog/post/ryujit-ctp5-and-loop-unrolling/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/ryujit-ctp5-and-loop-unrolling/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/jit-version-determining-in-runtime/'>JIT version determining in runtime</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> February 28, 2015.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
                <a href="/blog/tag/jit"><span class="badge badge-pill badge-info">JIT</span></a>
        </span><br /><br />
        <p>Sometimes I want to know used JIT compiler version in my little C# experiments. It is clear that it is possible to determine the version in advance based on the environment. However, sometimes I want to know it in runtime to perform specific code for the current JIT compiler. More formally, I want to get the value from the following enum:</p>
<pre><code class="language-cs">public enum JitVersion
{
    Mono, MsX86, MsX64, RyuJit
}
</code></pre>
<p>It is easy to detect Mono by existing of the <code>Mono.Runtime</code> class. Otherwise, we can assume that we work with Microsoft JIT implementation. It is easy to detect JIT-x86 with help of <code>IntPtr.Size == 4</code>. The challenge is to distinguish JIT-x64 and RyuJIT. Next, I will show how you can do it with help of the bug from my <a href="http://aakinshin.net/en/blog/dotnet/subexpression-elimination-bug-in-jit-x64/">previous post</a>.</p>
</p>
        <a href='/blog/post/jit-version-determining-in-runtime/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/jit-version-determining-in-runtime/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/subexpression-elimination-bug-in-jit-x64/'>A bug story about JIT-x64</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> February 27, 2015.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
                <a href="/blog/tag/jit"><span class="badge badge-pill badge-info">JIT</span></a>
                <a href="/blog/tag/bugs"><span class="badge badge-pill badge-info">Bugs</span></a>
        </span><br /><br />
        <p>Can you say, what will the following code display for <code>step=1</code>?</p>
<pre><code class="language-cs">public void Foo(int step)
{
    for (int i = 0; i &lt; step; i++)
    {
        bar = i + 10;
        for (int j = 0; j &lt; 2 * step; j += step)
            Console.WriteLine(j + 10);
    }
}
</code></pre>
<p>If you think about specific numbers, you are wrong. The right answer: it depends. The post title suggests to us, the program can has a strange behavior for x64.</p>
        <a href='/blog/post/subexpression-elimination-bug-in-jit-x64/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/subexpression-elimination-bug-in-jit-x64/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/inlining-and-starg/'>A story about JIT-x86 inlining and starg</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> February 26, 2015.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
                <a href="/blog/tag/inlining"><span class="badge badge-pill badge-info">Inlining</span></a>
        </span><br /><br />
        <p>Sometimes you can learn a lot during reading source .NET. Let's open the source code of a <code>Decimal</code> constructor from .NET Reference Source (<a href="http://referencesource.microsoft.com/#mscorlib/system/decimal.cs,158">mscorlib/system/decimal.cs,158</a>):</p>
<pre><code class="language-cs">// Constructs a Decimal from an integer value.
//
public Decimal(int value) {
    //  JIT today can't inline methods that contains &quot;starg&quot; opcode.
    //  For more details, see DevDiv Bugs 81184: x86 JIT CQ: Removing the inline striction of &quot;starg&quot;.
    int value_copy = value;
    if (value_copy &gt;= 0) {
        flags = 0;
    }
    else {
        flags = SignMask;
        value_copy = -value_copy;
    }
    lo = value_copy;
    mid = 0;
    hi = 0;
}
</code></pre>
<p>The comment states that JIT-x86 can't apply the inlining optimization for a method that contains the <a href="https://msdn.microsoft.com/library/system.reflection.emit.opcodes.starg.aspx">starg</a> IL-opcode. Curious, is not it? </p>
        <a href='/blog/post/inlining-and-starg/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/inlining-and-starg/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/mono-utf8-conversions/'>About UTF-8 conversions in Mono</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> November 10, 2014.
          <b>Tags:</b>
                <a href="/blog/tag/encodings"><span class="badge badge-pill badge-info">Encodings</span></a>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/mono"><span class="badge badge-pill badge-info">Mono</span></a>
        </span><br /><br />
        <p>This post is a logical continuation of the Jon Skeet's blog post <a href="http://codeblog.jonskeet.uk/2014/11/07/when-is-a-string-not-a-string">“When is a string not a string?”</a>. Jon showed very interesting things about behavior of ill-formed Unicode strings in .NET. I wondered about how similar examples will work on Mono. And I have got very interesting results.</p>
<h3 id="experiment-1-compilation">Experiment 1: Compilation</h3>
<p>Let's take the Jon's code with a small modification. We will just add <code>text</code> null check in <code>DumpString</code>:</p>
<pre><code class="language-cs">using System;
using System.ComponentModel;
using System.Text;
using System.Linq;
[Description(Value)]
class Test
{
    const string Value = &quot;X\ud800Y&quot;;
    static void Main()
    {
        var description = (DescriptionAttribute)typeof(Test).
            GetCustomAttributes(typeof(DescriptionAttribute), true)[0];
        DumpString(&quot;Attribute&quot;, description.Description);
        DumpString(&quot;Constant&quot;, Value);
    }
    static void DumpString(string name, string text)
    {
        Console.Write(&quot;{0}: &quot;, name);
        if (text != null)
        {
            var utf16 = text.Select(c =&gt; ((uint) c).ToString(&quot;x4&quot;));
            Console.WriteLine(string.Join(&quot; &quot;, utf16));
        }
        else
            Console.WriteLine(&quot;null&quot;);
    }
}
</code></pre>
</p>
        <a href='/blog/post/mono-utf8-conversions/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/mono-utf8-conversions/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/happy-monday/'>Happy Monday!</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> August 11, 2014.
          <b>Tags:</b>
                <a href="/blog/tag/bugs"><span class="badge badge-pill badge-info">Bugs</span></a>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/hate"><span class="badge badge-pill badge-info">Hate</span></a>
                <a href="/blog/tag/postsharp"><span class="badge badge-pill badge-info">PostSharp</span></a>
        </span><br /><br />
        <p>Today I tell you a story about one tricky bug. The bug is a tricky one because it doesn't allow me to debug my application on Mondays. I'm serious right now: the debug mode doesn't work every Monday. Furthermore, the bug literally tell me: &quot;Happy Monday!&quot;.</p>
<p>So, the story. It was a wonderful Sunday evening, no signs of trouble. We planned to release a new version of our software (a minor one, but it includes some useful features). Midnight on the clock. Suddenly, I came up with the idea that we have a minor bug that should be fixed. It requires a few lines of code and 10 minutes to do it. And I decided to write needed logic before I go to sleep. I open VisualStudio, lunch build, and wait. But something goes wrong, because I get the following error:</p>
<pre><code>Error connecting to the pipe server.
</code></pre>
<p>Hmm. It is a strange error. </p>
        <a href='/blog/post/happy-monday/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/happy-monday/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/findelementsinhostcoordinates/'>Strange behavior of FindElementsInHostCoordinates in WinRT</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> April 29, 2014.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
                <a href="/blog/tag/silverlight"><span class="badge badge-pill badge-info">Silverlight</span></a>
                <a href="/blog/tag/winrt"><span class="badge badge-pill badge-info">WinRT</span></a>
        </span><br /><br />
        <p>Silverlight features a splendid method: <a href="http://msdn.microsoft.com/en-us/library/system.windows.media.visualtreehelper.findelementsinhostcoordinates(v=vs.95).aspx">VisualTreeHelper.FindElementsInHostCoordinates</a>. It allows the <code>HitTest</code>, i.e. makes it possible for a point or rectangle to search for all visual sub-tree objects that intersect this rectangle or point. Formally the same method <a href="http://msdn.microsoft.com/en-us/library/windows/apps/windows.ui.xaml.media.visualtreehelper.findelementsinhostcoordinates.aspx">VisualTreeHelper.FindElementsInHostCoordinates</a> is available in WinRT. And it seems the method looks in the same way, but there is a little nuance. It works differently in different versions of the platform. So, let’s see what’s going on.</p>
        <a href='/blog/post/findelementsinhostcoordinates/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/findelementsinhostcoordinates/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/system-drawing-color-equals/'>About System.Drawing.Color and operator ==</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> February 21, 2014.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/colors"><span class="badge badge-pill badge-info">Colors</span></a>
                <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
                <a href="/blog/tag/equals"><span class="badge badge-pill badge-info">Equals</span></a>
        </span><br /><br />
        <p>Operator <code>==</code> that allows easy comparison of your objects is overridden for many standard structures in .NET. Unfortunately, not every developer really knows what is actually compared when working with this wonderful operator. This brief blog post will show the comparison logic based on a sample of <code>System.Drawing.Color</code>. What do you think the following code will get:</p>
<pre><code class="language-cs">var redName = Color.Red;
var redArgb = Color.FromArgb(255, 255, 0, 0);
Console.WriteLine(redName == redArgb);
</code></pre>
</p>
        <a href='/blog/post/system-drawing-color-equals/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/system-drawing-color-equals/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/msbuild-configurations/'>Setting up build configuration in .NET</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> February 08, 2014.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/msbuild"><span class="badge badge-pill badge-info">MSBuild</span></a>
                <a href="/blog/tag/configurations"><span class="badge badge-pill badge-info">Configurations</span></a>
        </span><br /><br />
        <p>You get two default build configurations: Debug and Release, when creating a new project in Visual Studio. And it’s enough for most small projects. But there can appear a necessity to extend it with the additional configurations. It’s ok if you need to add just a couple of new settings, but what if there are tens of such settings? And what if your solution contains 20 projects that need setting up of these configurations? In this case it becomes quite difficult to manage and modify build parameters.</p>
<p>In this article, we will review a way to make this process simpler by reducing description of the build configurations.</p>
        <a href='/blog/post/msbuild-configurations/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/msbuild-configurations/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/jon-skeet-quiz/'>Jon Skeet&#39;s Quiz</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> November 03, 2013.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
        </span><br /><br />
        <p>Jon Skeet was once asked to give three questions to check how well you know C#. He asked the <a href="http://www.dotnetcurry.com/magazine/jon-skeet-quiz.aspx">following questions</a>:</p>
<ul>
<li><strong>Q1.</strong> <em>What constructor call can you write such that this prints True (at least on the Microsoft .NET implementation)?</em></li>
</ul>
<pre><code class="language-cs">object x = new /* fill in code here */;
object y = new /* fill in code here */;
Console.WriteLine(x == y);
</code></pre>
<p><em>Note that it’s just a constructor call, and you can’t change the type of the variables.</em></p>
<ul>
<li><strong>Q2.</strong> <em>How can you make this code compile such that it calls three different method overloads?</em></li>
</ul>
<pre><code class="language-cs">void Foo()
{
    EvilMethod&lt;string&gt;();
    EvilMethod&lt;int&gt;();
    EvilMethod&lt;int?&gt;();
}
</code></pre>
<ul>
<li><strong>Q3.</strong> <em>With a local variable (so no changing the variable value cunningly), how can you make this code fail on the second line?</em></li>
</ul>
<pre><code class="language-cs">string text = x.ToString(); // No exception
Type type = x.GetType(); // Bang!
</code></pre>
<p>These questions seemed interesting to me, that is why I decided to discuss the solutions.</p>
        <a href='/blog/post/jon-skeet-quiz/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/jon-skeet-quiz/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/gc-native/'>Unexpected area to collect garbage in .NET</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> August 08, 2013.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/gc"><span class="badge badge-pill badge-info">GC</span></a>
                <a href="/blog/tag/opencv"><span class="badge badge-pill badge-info">OpenCV</span></a>
        </span><br /><br />
        <p>The .NET framework provides an intelligent garbage collector that saves us a trouble of manual memory management. And in 95% of cases you can forget about memory and related issues. But the remaining 5% have some specific aspects connected to unmanaged resources, too big objects, etc. And it’s better to know how the garbage is collected. Otherwise, you can get surprises.</p>
<p>Do you think GC is able to collect an object till its last method is complete? It appears it is. But it is necessary to run an application in release mode without debugging. In this case JIT compiler will perform optimizations that will make this situation possible. Of course, JIT compiler does it when the remaining method body doesn’t contain references to the object or its fields. It should seem a very harmless optimization. But it can lead to the problems if you work with the unmanaged resources: object compilation can be executed before the operation over the unmanaged resource is finished. And most likely it will result in the application crash. </p>
        <a href='/blog/post/gc-native/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/gc-native/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/closures/'>Unobviousness in use of C# closures</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> August 07, 2013.
          <b>Tags:</b>
                <a href="/blog/tag/lambda"><span class="badge badge-pill badge-info">Lambda</span></a>
                <a href="/blog/tag/closures"><span class="badge badge-pill badge-info">Closures</span></a>
                <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
        </span><br /><br />
        <p>C# gives us an ability to use closures. This is a powerful tool that allows anonymous methods and lambda-functions to capture unbound variables in their lexical scope. And many programmers in .NET world like using closures very much, but only few of them understand how they really work. Let’s start with a simple sample:</p>
<pre><code class="language-cs">public void Run()
{
  int e = 1;
  Foo(x =&gt; x + e);
}
</code></pre>
<p>Nothing complicated happens here: we just captured a local variable <code>e</code> in its lambda that is passed to some <code>Foo</code> method. Let’s see how the compiler will expand such construction.*</p>
<pre><code class="language-cs">public void Run()
{
  DisplayClass c = new DisplayClass();
  c.e = 1;  
  Foo(c.Action);
}
private sealed class DisplayClass
{
  public int e;
  public int Action(int x)
  {
    return x + e;
  }
}
</code></pre>
</p>
        <a href='/blog/post/closures/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/closures/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
<div class="blog-post">
        <h2 class="blog-post-title"><a href='/blog/post/wrap-cs-in-com/'>Wrapping C# class for use in COM</a></h2>
        <span class="blog-post-meta">
          <b>Date:</b> June 03, 2013.
          <b>Tags:</b>
                <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
                <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
                <a href="/blog/tag/com"><span class="badge badge-pill badge-info">COM</span></a>
        </span><br /><br />
        <p>Let us have a C# class that makes something useful, for example:</p>
<pre><code class="language-cs">public class Calculator
{
    public int Sum(int a, int b)
    {
        return a + b;
    }
}
</code></pre>
<p>Let’s create a <a href="http://ru.wikipedia.org/wiki/Component_Object_Model">COM</a> interface for this class to make it possible to use its functionality in other areas. At the end we will see how this class is used in Delphi environment.</p>
        <a href='/blog/post/wrap-cs-in-com/'>Read more</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="/blog/post/wrap-cs-in-com/#disqus_thread">Comments</a><br /><br />
        <hr />
    </div>
</div>
    </div>

    <footer class="blog-footer">
      <div class="container">
        <p>&copy; 2014–2017 Andrey Akinshin</p>
      </div>
    </footer>

    <!-- jQuery first, then Tether, then Bootstrap JS. -->
    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    <!-- Other scripts -->
    <script src="/js/highlight.pack.js"></script>
    <script src="/js/anchor.min.js"></script>
    <script src="/js/custom.js"></script>
  </body>
</html>
