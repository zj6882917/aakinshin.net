<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="InvalidDataException in Process.GetProcesses">
    <meta name="author" content="Andrey Akinshin">
    <link href="/img/favicon.ico?v=2" rel="icon" type="image/x-icon"/>
    <meta name="keywords" content='.NET,Rider,Bugs,Xplat,CoreCLR'>

    <title>InvalidDataException in Process.GetProcesses</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">

    <!-- Custom styles -->
    <link href="/css/about.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/blog.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/highlight.css" rel="stylesheet" type="text/css" media="all">

    <!-- Bootstrap scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js" integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js" integrity="sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK" crossorigin="anonymous"></script>

    <!-- Other stuff -->
    <link href="/en/rss.xml" type="application/rss+xml" rel="alternate" title="Blog RSS Feed" />
    <link href="/en/atom.xml" type="application/atom+xml" rel="alternate" title="Blog ATOM Feed" />

    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-41419012-5', 'auto');
      ga('send', 'pageview');
    </script>
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter28700916 = new Ya.Metrika({id:28700916,
                        clickmap:true,
                        trackLinks:true,
                        accurateTrackBounce:true});
            } catch(e) { }
        });
        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";
        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
    </script>
    <!-- /Yandex.Metrika counter -->
    <!-- MathJax -->
    <script type="text/x-mathjax-config">
       MathJax.Hub.Config({
        extensions: ["jsMath2jax.js"]
      });
    </script>
    <script
      src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
    </script>
    <!-- Disqus -->
    <script id="dsq-count-scr" src="//aakinshinnet-en.disqus.com/count.js" async></script>
  </head>

  <body>
     <div class="blog-masthead">
      <div class="container">
        <nav class="nav blog-nav">
          <a class="nav-link" id="nav-link-blog" href="/en/blog/">Blog</a>
          <a class="nav-link" id="nav-link-blog" href="/en/blog/featured/">Featured</a>
          <a class="nav-link" id="nav-link-blog-content" href="/en/blog/content/">Content</a>
          <a class="nav-link" id="nav-link-about" href="/en/about/">About author</a>
          <a class="nav-link" href='/ru/blog/dotnet/invaliddataexception-in-getprocesses/'>Russian version</a>
        </nav>
      </div>
    </div>

    <div class="container">
      <div class="blog-main">
<div class="blog-post">

<h2 class="blog-post-title" id="post-title">InvalidDataException in Process.GetProcesses</h2>

<span class="blog-post-meta">
  <b>Date:</b> February 10, 2017.
  <b>Category:</b> <a href="/en/blog/content/#dotnet"><span class="tag tag-info">.NET</span></a>
  <b>Tags:</b>
        <a href="/en/blog/tags/#.NET"><span class="tag tag-pill tag-info">.NET</span></a>
        <a href="/en/blog/tags/#Rider"><span class="tag tag-pill tag-info">Rider</span></a>
        <a href="/en/blog/tags/#Bugs"><span class="tag tag-pill tag-info">Bugs</span></a>
        <a href="/en/blog/tags/#Xplat"><span class="tag tag-pill tag-info">Xplat</span></a>
        <a href="/en/blog/tags/#CoreCLR"><span class="tag tag-pill tag-info">CoreCLR</span></a>
</span><br /><br />

<p>Consider the following program:</p>
<pre><code class="language-cs">public static void Main(string[] args)
{
    try
    {
        Process.GetProcesses();
    }
    catch (Exception e)
    {
        Console.WriteLine(e);
    }
}
</code></pre>
<p>It seems that all the exception should be caught.
However, <em>sometimes</em> I had the following exception on Linux with <code>dotnet cli-1.0.0-preview2</code>:</p>
<pre><code>$ dotnet run
System.IO.InvalidDataException: Found invalid data while decoding.
   at System.IO.StringParser.ParseNextChar()
   at Interop.procfs.TryParseStatFile(String statFilePath, ParsedStat&amp; result, ReusableTextReader reusableReader)
   at System.Diagnostics.ProcessManager.CreateProcessInfo(ParsedStat procFsStat, ReusableTextReader reusableReader)
   at System.Diagnostics.ProcessManager.CreateProcessInfo(Int32 pid, ReusableTextReader reusableReader)
   at System.Diagnostics.ProcessManager.GetProcessInfos(String machineName)
   at System.Diagnostics.Process.GetProcesses(String machineName)
   at System.Diagnostics.Process.GetProcesses()
   at DotNetCoreConsoleApplication.Program.Main(String[] args) in /home/akinshin/Program.cs:line 12
</code></pre>
<p>How does it possible?</p>
<!--more-->
<h3 id="preamble">Preamble</h3>
<p>I'm a guy who writes unit testing support in <a href="https://www.jetbrains.com/rider/">Rider</a>.
And it works fine with classic unit tests on the full .NET framework and mono.
I know that there are many bugs here (Rider is still in the EAP stage), but at least it works:
you can discover tests, run them, and even debug them.
However, we also have to support new dotnet cli test toolchain.
And there are many troubles with coreclr (probably because it is also in the preview stage).
Even if our communication logic with <code>dotnet test</code> works on Windows, it doesn't mean that it works on Linux and MacOS.
Today I want to tell you a story about one bug investigation.
In fact, we have a lot of such stories, but this one is in my favorite bug list.
This story happened in October 2016, so I will tell you about <code>dotnet cli-1.0.0-preview2</code> (in <code>preview4</code> bug was fixed).</p>
<h3 id="situation">Situation</h3>
<p>Do you know, what happens when you click 'Run' on a unit test from a modern C# project (e.g. based on project.json) in Rider?
It starts a new process like this:</p>
<pre><code>$ dotnet test --port 36513 --parentProcessId 3624 --no-build --framework net451
</code></pre>
<p>And it works perfectly on Windows. On Linux, I had the following exception:</p>
<pre><code>dotnet-test Error: 0 : System.IO.InvalidDataException: Found invalid data while decoding.
   at System.IO.StringParser.ParseNextChar()
   at Interop.procfs.TryParseStatFile(String statFilePath, ParsedStat&amp; result, ReusableTextReader reusableReader)
   at System.Diagnostics.ProcessManager.CreateProcessInfo(ParsedStat procFsStat, ReusableTextReader reusableReader)
   at System.Diagnostics.ProcessManager.CreateProcessInfo(Int32 pid, ReusableTextReader reusableReader)
   at System.Diagnostics.ProcessManager.GetProcessInfos(String machineName)
   at System.Diagnostics.Process.GetProcesses(String machineName)
   at System.Diagnostics.Process.GetProcesses()
   at Microsoft.DotNet.Tools.Test.TestCommand.RegisterForParentProcessExit(Int32 id)
   at Microsoft.DotNet.Tools.Test.TestCommand.DoRun(String[] args)
</code></pre>
<h3 id="investigation">Investigation</h3>
<p>It seems that the problem is in <code>Process.GetProcesses()</code>.
It was easy to write a minimal repro which produces this bug (you can find it at the beginning of the post).
Usually, I do a final check for such bugs in a sterile environment: I close all the application and run it from the terminal.
Guess what?
My little program works without any exception now.
Hmmm...
Ok, open this wonderful program in Rider and run it: the <code>InvalidDataException</code> is in his place.
Hmmm...
Ok, another experiment: keep Rider opened and run the program from the terminal: we again see <code>InvalidDataException</code>.
Huh!
It seems that if we want to reproduce the bug, we have to run the program while Rider is running too.</p>
<p>At this point, I decided to create an issue on GitHub: <a href="https://github.com/dotnet/corefx/issues/12755">dotnet/corefx#12755</a>.
Thanks to <a href="https://github.com/stephentoub">@stephentoub</a>, he helped me to understand what is going on here.</p>
<h3 id="explanation">Explanation</h3>
<p>Rider is based on the <a href="https://www.jetbrains.com/idea/">IntelliJ</a> platform and <a href="https://www.jetbrains.com/resharper/">ReSharper</a>.
So, we have two main processes: a JVM process and a CLR process.
The name if the CLR process is <code>JetBrains.ReSharper.Host.exe</code> which includes a lot of threads.
ReSharper is very complicated multithreading application, and we have own pool of threads (which one has the own name).
Here is a bug <a href="https://github.com/dotnet/corefx/issues/12755#issuecomment-254853345">explanation</a> by <a href="https://github.com/stephentoub">@stephentoub</a>:</p>
<blockquote>
<p>The JetBrains.ReSharper.Host.exe process has a thread in it with a name that includes spaces: &quot;JetPool (S) Reg&quot;.
When we're parsing the processes' task list looking for its threads, we parse the stat file for each task, and in doing so, we misinterpret the space in the name as a space separator for the other items in the line.
The fix in System.Diagnostics.Process is likely to track the parens and ensure we treat the whole parenthesized unit as the name.
In the meantime, as a workaround, if you have control over the thread/task's name (something somewhere is probably calling a function like pthread_setname_np, or using prctl with PR_SET_NAME), you could try using a name that doesn't include spaces.</p>
</blockquote>
<h3 id="workaround">Workaround</h3>
<p>Now the bug if fixed, it is a part of
<a href="https://github.com/dotnet/corefx/pull/12791">.NET Core 2.0</a> and
<a href="https://github.com/dotnet/cli/issues/4452">dotnet cli 1.0.0-preview4</a>.
However, many people still use dotnet cli 1.0.0-preview2 and Rider should support it for some time.
We came up with a workaround which allows running unit tests with preview2:
we just don't specify <code>--parentProcessId</code> on Linux/MacOS:</p>
<pre><code class="language-cs">var commonArgs = string.Format(&quot;test --port {0} --no-build{1}&quot;,
    server.PortNumber, frameworkArg);
var windowsArgs = string.Format(&quot;test --port {0} --parentProcessId {1} --no-build{2}&quot;,
    server.PortNumber, Process.GetCurrentProcess().Id, frameworkArg);
var args = PlatformUtil.IsRunningUnderWindows ? windowsArgs : commonArgs;
</code></pre>
<p>In this case, <code>dotnet</code> doesn't call <code>Process.GetProcesses()</code> and everything works fine.
Rider is able to establish a connection even when the <code>--parentProcessId</code> parameter is omitted.</p>
<p>Of course, we also can rename our threads, but I wanted to fix the bug without any changes in the ReSharper core libraries.</p>
<h3 id="conclusion">Conclusion</h3>
<p>In Rider, we should support many bleeding edge technologies which contain a lot of bugs.
Hopefully, a big part of such technologies will die soon (and will be replaced by stable version).
However, people can't update all their projects on the same day with the next release of its dependencies.
So, we have to maintain a lot of hacks and ugly pieces of code for a several months after the date when another preview was released.
It's not easy, and it conflicts with our sense of beauty,
but we still try to do everything to make our users happy regardless of which version of runtime they use.</p>
<h3 id="links">Links</h3>
<ul>
<li><a href="https://github.com/dotnet/corefx/issues/12755">dotnet/corefx#12755: InvalidDataException in Process.GetProcesses on Linux</a></li>
<li><a href="https://github.com/dotnet/corefx/pull/12791">dotnet/corefx#12791: Fix parsing of procfs stat files when comm name contains spaces</a></li>
<li><a href="https://github.com/dotnet/corefx/issues/12834">dotnet/corefx#12834: Linux: System.Diagnostics.Process.GetProcesses can throw if reading from /proc for any process fails</a></li>
<li><a href="https://github.com/dotnet/cli/issues/4452">dotnet/cli#4452: &quot;dotnet test&quot; crashes if another process or thread has a name with a space</a></li>
</ul>

<!-- Share -->

Share:
<a href="https://twitter.com/intent/tweet?text=InvalidDataException in Process.GetProcesses&url=http://aakinshin.net/en/blog/dotnet/invaliddataexception-in-getprocesses/&via=andrey_akinshin&related=andrey_akinshin" rel="nofollow" target="_blank" title="Share on Twitter"><img class="share-button" src="/img/icons/twitter.png" alt="" /></a>
<a href="https://www.reddit.com/submit?url=http://aakinshin.net/en/blog/dotnet/invaliddataexception-in-getprocesses/" target="_blank" title="Share on Reddit"> <img class="share-button" src="/img/icons/reddit.png" alt="" border="0" /> </a>
<a href="https://news.ycombinator.com/submitlink?u=http://aakinshin.net/en/blog/dotnet/invaliddataexception-in-getprocesses/" target="_blank" title="Share on HackerNews"> <img class="share-button" src="/img/icons/hn.png" alt="" border="0" /> </a>
<a href="https://facebook.com/sharer.php?u=http://aakinshin.net/en/blog/dotnet/invaliddataexception-in-getprocesses/" rel="nofollow" target="_blank" title="Share on Facebook"><img class="share-button" src="/img/icons/facebook.png" alt="" /></a>
<a href="https://plus.google.com/share?url=http://aakinshin.net/en/blog/dotnet/invaliddataexception-in-getprocesses/" rel="nofollow" target="_blank" title="Share on Google+"><img class="share-button" src="/img/icons/google-plus.png" alt="" /></a>
<a href="http://vk.com/share.php?url=http://aakinshin.net/en/blog/dotnet/invaliddataexception-in-getprocesses/" target="_blank" title="Share on VKontakte"><img class="share-button" src="/img/icons/vk.png" alt="" /></a>
<hr />

<!-- GitHub -->
<div>
  You can find source code of this post on GitHub:<br />
  <a href="https://github.com/AndreyAkinshin/aakinshin.net/blob/master/en/_posts/dotnet/invaliddataexception-in-getprocesses.md">https://github.com/AndreyAkinshin/aakinshin.net/blob/master/en/_posts/dotnet/invaliddataexception-in-getprocesses.md</a>
</div>

<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    // Disqus
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'aakinshinnet-en'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>
</div>
    </div>

    <footer class="blog-footer">
      <div class="container">
        <p>&copy; 2014–2017 Andrey Akinshin</p>
      </div>
    </footer>

    <script>
    $(function() {
       // standard classes
       $("table").addClass("table");
       $("table").addClass("table-bordered");
       $("table").addClass("table-hover");
       $("table").addClass("table-condensed");
       $("blockquote").addClass("blockquote");

       // nav
       var url = $(location).attr('href');
       if (url.indexOf("/blog/content") != -1) {
           $("#nav-link-blog-content").addClass("active");
       } else if (url.indexOf("/blog") != -1) {
           $("#nav-link-blog").addClass("active");
       } else if (url.indexOf("/about") != -1) {
           $("#nav-link-about").addClass("active");
       }
    });
    </script>
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/anchor.min.js"></script>
    <script>
      anchors.options = {
        placement: 'left',
        icon: '§'
      };
      anchors.add('h1');
      anchors.add('h2');
      anchors.add('h3');
    </script>
  </body>
</html>
